<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.kh.earth.challenge.model.dao.ChallengeMapper">
	<sql id="todayListSql">
		SELECT
		    CATEGORY,
		    CHAL_NO,
		    CHAL_TITLE,
		    CHAL_CONTENT,
		    CHAL_IMG_PATH,
		    CHAL_POINT,
		    CHAL_DATE
		FROM CHAL_TODAY
	</sql>
	
	<sql id="monthListSql">
		SELECT
		    CATEGORY,
		    CHAL_NO,
		    CHAL_TITLE,
		    CHAL_CONTENT,
		    CHAL_IMG_PATH,
		    CHAL_POINT,
		    CHAL_COUNT,
		    CHAL_DATE,
		    CHAL_MODIFY_DATE
		FROM CHAL_MONTH
	</sql>
	
	<!-- 오늘의 챌린지 목록 -->
	<resultMap type="Today" id="todayListResultMap">
		<id property="chalNo" column="CHAL_NO" />
		<result property="category" column="CATEGORY" />
		<result property="chalTitle" column="CHAL_TITLE" />
		<result property="chalContent" column="CHAL_CONTENT" />
		<result property="chalImgPath" column="CHAL_IMG_PATH" />
		<result property="chalPoint" column="CHAL_POINT" />
		<result property="chalDate" column="CHAL_DATE" />
	</resultMap>
	
	<!-- 오늘의 챌린지 참여 회원 목록 -->
	<resultMap type="TodayMember" id="todayMemberResultMap">
		<id property="no" column="NO" />
		<result property="memNo" column="MEM_NO" />
		<result property="chalNo" column="CHAL_NO" />
		<result property="chalTitle" column="T_CHAL_TITLE" />
		<result property="chalDate" column="CHAL_DATE" />
		<result property="chalStatus" column="CHAL_STATUS" />
		<result property="originalFilename" column="ORIGINAL_FILENAME" />
		<result property="renamedFilename" column="M_RENAMED_FILENAME" />
		<result property="chalPoint" column="CHAL_POINT" />
		<result property="chalPointStatus" column="CHAL_POINT_STATUS" />
	</resultMap>
	
	<!-- 이달의 챌린지 목록 -->
	<resultMap type="Month" id="MonthListResultMap">
		<id property="chalNo" column="CHAL_NO" />
		<result property="category" column="CATEGORY" />
		<result property="chalTitle" column="CHAL_TITLE" />
		<result property="chalContent" column="CHAL_CONTENT" />
		<result property="chalImgPath" column="CHAL_IMG_PATH" />
		<result property="chalPoint" column="CHAL_POINT" />
		<result property="chalCount" column="CHAL_COUNT" />
		<result property="chalDate" column="CHAL_DATE" />
		<result property="chalModifyDate" column="CHAL_MODIFY_DATE" />
	</resultMap>
	
	<!-- 이달의 챌린지 참여 회원 목록 -->
	<resultMap type="MonthMember" id="MonthMemberResultMap">
		<id property="no" column="NO" />
		<result property="memNo" column="T_MEM_NO" />
		<result property="id" column="MEMBER_ID" />
		<result property="chalNo" column="CHAL_NO" />
		<result property="chalTitle" column="T_CHAL_TITLE" />
		<result property="chalDate" column="CHAL_DATE" />
		<result property="originalFilename" column="ORIGINAL_FILENAME" />
		<result property="renamedFilename" column="M_RENAMED_FILENAME" />
		<result property="modifyImgName" column="MEMBER_MODIFY_IMG_NAME" />
		<result property="chalPoint" column="CHAL_COUNT" />
		<result property="chalStatus" column="CHAL_STATUS" />
		<result property="chalPoint" column="CHAL_POINT" />
		<result property="chalPointStatus" column="CHAL_POINT_STATUS" />
	</resultMap>
	
	
	
	
  	
  	<!-- 오늘의 챌린지 목록 조회 -->
  	<select id="findAllToday" parameterType="map" resultMap="todayListResultMap">
		<include refid="todayListSql" />
  	</select>
  	
  	<!-- 오늘의 챌린지 상세 조회 -->
  	<select id="selectTodayListByNo" parameterType="_int" resultMap="todayListResultMap">
		<include refid="todayListSql" />
		WHERE CHAL_NO = #{ chalNo }
	</select>
	
	<!-- 오늘의 챌린지 인증 완료 시, 완료 챌린지명 / 파일명 조회 -->
	<select id="findChalTitle" parameterType="map" resultMap="todayMemberResultMap">
		SELECT
		    T.CHAL_TITLE AS T_CHAL_TITLE,
		    M.RENAMED_FILENAME AS M_RENAMED_FILENAME
		FROM CHAL_TODAY_MEM M
		JOIN CHAL_TODAY T ON (M.CHAL_NO = T.CHAL_NO)
		WHERE M.CHAL_NO = #{ chalNo } AND M.MEM_NO = #{ no }
	</select>
	
  	<!-- 오늘의 챌린지 인증 시 참여 회원 저장 -->
  	<insert id="insertTodayMember" parameterType="map" useGeneratedKeys="true" keyColumn="NO" keyProperty="no">
		INSERT INTO CHAL_TODAY_MEM (
			NO,
			MEM_NO,
			CHAL_NO,
			CHAL_DATE,
			CHAL_STATUS,
			ORIGINAL_FILENAME,
			RENAMED_FILENAME,
			CHAL_POINT,
			CHAL_POINT_STATUS
		) VALUES (
			SEQ_CHLG_TODAY_MEM.NEXTVAL,
			#{ no },
			#{ chalNo },
			DEFAULT,
			DEFAULT,
			#{ originalFilename },
			#{ renamedFilename },
			1000,
			DEFAULT
		)
	</insert>
	
	<!-- 오늘의 챌린지 참여 회원 목록 조회 -->
	<select id="selectTodayMemberListByNo" parameterType="arraylist" resultMap="todayMemberResultMap">
		<!-- SELECT 
			M.NO,
			M.MEM_NO,
			M.CHAL_NO,
			T.CHAL_TITLE,
			M.CHAL_DATE,
			M.CHAL_STATUS,
			M.ORIGINAL_FILENAME,
			M.RENAMED_FILENAME,
			M.CHAL_POINT,
			M.CHAL_POINT_STATUS
		FROM CHAL_TODAY_MEM M
		JOIN CHAL_TODAY T ON (M.CHAL_NO = T.CHAL_NO)
		WHERE M.MEM_NO = #{ no } -->
		SELECT 
			CHAL_NO,
			CHAL_DATE
		FROM CHAL_TODAY_MEM
		WHERE MEM_NO = #{ no }
		ORDER BY NO
	</select>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<!-- 이달의 챌린지 전체 목록 개수 조회 -->
  	<select id="getBoardCount" parameterType="map" resultType="_int">
  		SELECT COUNT (*)
  		FROM CHAL_MONTH
  	</select>
  	
	<!-- 이달의 챌린지 목록 조회 -->
	<select id="findAllMonth" parameterType="map" resultMap="MonthListResultMap">
		<include refid="monthListSql" />
		ORDER BY CHAL_NO DESC
  	</select>
  	
  	<!-- 이달의 챌린지 목록 조회 + 정렬 -->
  	<select id="findAllMonthArrange" parameterType="string" resultMap="MonthListResultMap">
		<include refid="monthListSql" />
		<if test="arrange == '최신순'">
			ORDER BY CHAL_NO DESC
		</if>
		<if test="arrange == '높은포인트순'">
			ORDER BY CHAL_POINT DESC, CHAL_NO DESC
		</if>
		<if test="arrange == '낮은포인트순'">
			ORDER BY CHAL_POINT ASC, CHAL_NO DESC
		</if>
  	</select>
  	
  	<!-- 이달의 챌린지 상세 조회 -->
  	<select id="selectMonthListByNo" parameterType="_int" resultMap="MonthListResultMap">
		<include refid="monthListSql" />
		WHERE CHAL_NO = #{ chalNo }
	</select>
	
	<!-- 이달의 챌린지 인증 완료 시, 완료 챌린지명 / 파일명 조회 -->
	<select id="findMonthCompleteList" parameterType="map" resultMap="MonthMemberResultMap">
		SELECT
		    T.CHAL_TITLE AS T_CHAL_TITLE,
		    M.RENAMED_FILENAME AS M_RENAMED_FILENAME
		FROM CHAL_MONTH_MEM M
		JOIN CHAL_MONTH T ON (M.CHAL_NO = T.CHAL_NO)
		WHERE M.CHAL_NO = #{ chalNo } AND M.MEM_NO = #{ no }
		ORDER BY NO DESC
	</select>
	
	<!-- 이달의 챌린지 인증 시 참여 회원 저장 -->
  	<insert id="insertMonthMember" parameterType="map" useGeneratedKeys="true" keyColumn="NO" keyProperty="no">
		INSERT INTO CHAL_MONTH_MEM (
		    NO,
		    MEM_NO,
		    CHAL_NO,
		    CHAL_DATE,
		    ORIGINAL_FILENAME,
		    RENAMED_FILENAME,
		    CHAL_COUNT,
		    CHAL_STATUS,
		    CHAL_POINT,
		    CHAL_POINT_STATUS
		) VALUES (
		    SEQ_CHLG_MONTH_MEM.NEXTVAL,
		    #{ no },
		    #{ chalNo },
		    SYSDATE,
		    #{ originalFilename },
			#{ renamedFilename },
		    1,
		    DEFAULT,
		    1000,
		    DEFAULT
		)
	</insert>
	
	<!-- 참여 중인 사용자 목록 조회 -->
	<select id="findOngoingUserList" parameterType="map" resultMap="MonthMemberResultMap">
		SELECT DISTINCT
			MEMBER.MODIFY_IMG_NAME AS MEMBER_MODIFY_IMG_NAME,
			MEMBER.ID AS MEMBER_ID
		FROM MEMBER MEMBER
		JOIN CHAL_MONTH_MEM T ON (MEMBER.NO = T.MEM_NO)
		WHERE CHAL_NO = #{ chalNo } AND MEM_NO != #{ no }
	</select>
	
	<!-- 참여 중인 사용자 목록 갯수 조회 -->
	<select id="findOngoingUserCount" parameterType="_int" resultType="_int">
		SELECT COUNT (DISTINCT MEM_NO)
		FROM MEMBER MEMBER
		JOIN CHAL_MONTH_MEM T ON (MEMBER.NO = T.MEM_NO)
		WHERE CHAL_NO = #{ chalNo } AND MEM_NO != #{ no }
	</select>
	
	<!-- 이달의 챌린지 참여 횟수 조회 -->
	<select id="getMonthGuage" parameterType="arraylist" resultMap="MonthMemberResultMap">
		SELECT CHAL_COUNT
		FROM CHAL_MONTH_MEM
		WHERE MEM_NO = #{ no } AND CHAL_NO = #{ chalNo }
	</select>
</mapper>
