<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.kh.earth.challenge.model.dao.ChallengeMapper">
	<sql id="todayListSql">
		SELECT
		    CATEGORY,
		    CHAL_NO,
		    CHAL_TITLE,
		    CHAL_CONTENT,
		    CHAL_IMG_PATH,
		    CHAL_POINT,
		    START_DATE,
		    END_DATE,
		    CHAL_STATUS
		FROM CHAL_TODAY
	</sql>
	
	<sql id="monthListSql">
		SELECT
		    CATEGORY,
		    CHAL_NO,
		    CHAL_TITLE,
		    CHAL_CONTENT,
		    CHAL_IMG_PATH,
		    CHAL_POINT,
		    CHAL_COUNT,
		    START_DATE,
		    END_DATE,
		    CHAL_STATUS
		FROM CHAL_MONTH
	</sql>
	
	<!-- 오늘의 챌린지 목록 -->
	<resultMap type="Today" id="todayListResultMap">
		<id property="chalNo" column="CHAL_NO" />
		<result property="category" column="CATEGORY" />
		<result property="chalTitle" column="CHAL_TITLE" />
		<result property="chalContent" column="CHAL_CONTENT" />
		<result property="chalImgPath" column="CHAL_IMG_PATH" />
		<result property="chalPoint" column="CHAL_POINT" />
		<result property="startDate" column="START_DATE" />
		<result property="endtDate" column="END_DATE" />
		<result property="charStatus" column="CHAL_STAUTS" />
	</resultMap>
	
	<!-- 오늘의 챌린지 참여 회원 목록 -->
	<resultMap type="TodayMember" id="todayMemberResultMap">
		<id property="no" column="NO" />
		<result property="memNo" column="MEM_NO" />
		<result property="chalNo" column="CHAL_NO" />
		<result property="chalTitle" column="T_CHAL_TITLE" />
		<result property="chalDate" column="CHAL_DATE" />
		<result property="chalStatus" column="CHAL_STATUS" />
		<result property="originalFilename" column="ORIGINAL_FILENAME" />
		<result property="renamedFilename" column="M_RENAMED_FILENAME" />
		<result property="chalPoint" column="T_CHAL_POINT" />
		<result property="chalPointStatus" column="CHAL_POINT_STATUS" />
	</resultMap>
	
	<!-- 이달의 챌린지 목록 -->
	<resultMap type="Month" id="MonthListResultMap">
		<id property="chalNo" column="CHAL_NO" />
		<result property="category" column="CATEGORY" />
		<result property="chalTitle" column="CHAL_TITLE" />
		<result property="chalContent" column="CHAL_CONTENT" />
		<result property="chalImgPath" column="CHAL_IMG_PATH" />
		<result property="chalPoint" column="CHAL_POINT" />
		<result property="chalCount" column="CHAL_COUNT" />
		<result property="startDate" column="START_DATE" />
		<result property="endDate" column="END_DATE" />
		<result property="chalStatus" column="CHAL_STATUS" />
	</resultMap>
	
	<!-- 이달의 챌린지 참여 회원 목록 -->
	<resultMap type="MonthMember" id="MonthMemberResultMap">
		<id property="no" column="NO" />
		<result property="memNo" column="T_MEM_NO" />
		<result property="id" column="MEMBER_ID" />
		<result property="chalNo" column="CHAL_NO" />
		<result property="chalTitle" column="T_CHAL_TITLE" />
		<result property="chalDate" column="CHAL_DATE" />
		<result property="originalFilename" column="ORIGINAL_FILENAME" />
		<result property="renamedFilename" column="M_RENAMED_FILENAME" />
		<result property="modifyImgName" column="MEMBER_MODIFY_IMG_NAME" />
		<result property="chalPoint" column="CHAL_COUNT" />
		<result property="chalStatus" column="CHAL_STATUS" />
		<result property="chalPoint" column="T_CHAL_POINT" />
		<result property="chalPointStatus" column="CHAL_POINT_STATUS" />
	</resultMap>
	
	<!-- 포인트 -->
	<resultMap type="Point" id="pointListResultMap">
		<id property="pointNo" column="POINT_NO" />
		<result property="memNo" column="MEM_NO" />
		<result property="saveDate" column="SAVE_DATE" />
		<result property="content" column="CONTENT" />
		<result property="point" column="POINT" />
		<result property="disapearDate" column="DISAPEAR_DATE" />
	</resultMap>
	
	<!-- 댓글 -->
	<resultMap type="Reply" id="replyResultMap">
		<id property="replyNo" column="REPLY_NO" />
		<result property="memNo" column="MEM_NO" />
		<result property="chalNo" column="CHAL_NO" />
		<result property="content" column="CONTENT" />
		<result property="replyDate" column="REPLY_DATE" />
		<result property="modifyDate" column="MODIFY_DATE" />
		<result property="replyStatus" column="REPLY_STATUS" />
		<result property="modifyImgName" column="MODIFY_IMG_NAME" />
		<result property="id" column="ID" />
	</resultMap>
	
	
	
	
  	
  	<!-- 오늘의 챌린지 목록 조회 -->
  	<select id="findAllToday" parameterType="map" resultMap="todayListResultMap">
		<include refid="todayListSql" />
  	</select>
  	
  	<!-- 오늘의 챌린지 상세 조회 -->
  	<select id="selectTodayListByNo" parameterType="_int" resultMap="todayListResultMap">
		<include refid="todayListSql" />
		WHERE CHAL_NO = #{ chalNo }
	</select>
	
	<!-- 오늘의 챌린지 인증 완료 시, 완료 챌린지명 / 파일명 조회 -->
	<select id="findChalTitle" parameterType="map" resultMap="todayMemberResultMap">
		SELECT
		    T.CHAL_TITLE AS T_CHAL_TITLE,
		    T.CHAL_POINT AS T_CHAL_POINT,
		    M.RENAMED_FILENAME AS M_RENAMED_FILENAME
		FROM CHAL_TODAY_MEM M
		JOIN CHAL_TODAY T ON (M.CHAL_NO = T.CHAL_NO)
		WHERE M.CHAL_NO = #{ chalNo } AND M.MEM_NO = #{ no }
	</select>
	
  	<!-- 오늘의 챌린지 인증 시 참여 회원 저장 -->
  	<insert id="insertTodayMember" parameterType="map" useGeneratedKeys="true" keyColumn="NO" keyProperty="no">
		INSERT INTO CHAL_TODAY_MEM (
			NO,
			MEM_NO,
			CHAL_NO,
			CHAL_DATE,
			CHAL_STATUS,
			ORIGINAL_FILENAME,
			RENAMED_FILENAME,
			CHAL_POINT,
			CHAL_POINT_STATUS
		) VALUES (
			SEQ_CHLG_TODAY_MEM.NEXTVAL,
			#{ no },
			#{ chalNo },
			DEFAULT,
			DEFAULT,
			#{ originalFilename },
			#{ renamedFilename },
			1000,
			DEFAULT
		)
	</insert>
	
	<!-- 오늘의 챌린지 참여 회원 목록 조회 -->
	<select id="selectTodayMemberListByNo" parameterType="arraylist" resultMap="todayMemberResultMap">
		SELECT 
			CHAL_NO,
			CHAL_DATE
		FROM CHAL_TODAY_MEM
		WHERE MEM_NO = #{ no }
		ORDER BY NO
	</select>
	
	<!-- 챌린지 달성 시 포인트 업데이트 -->
	<insert id="insertPoint" parameterType="map" useGeneratedKeys="true" keyColumn="POINT_NO" keyProperty="pointNo">
		INSERT INTO POINT (
			POINT_NO,
			MEM_NO,
			SAVE_DATE,
			CONTENT,
			POINT,
			DISAPEAR_DATE
		) VALUES (
			SEQ_POINT.NEXTVAL,
			#{ memNo },
			DEFAULT,
			'챌린지 달성',
			#{ point },
			#{ disapearDate }
		)
	</insert>
	
	
	
	
	
	
	
	
	
	<resultMap type="Month" extends="MonthListResultMap" id="monthDetailResultMap">
		<collection property="replies" javaType="arraylist" columnPrefix="R_" resultMap="replyResultMap" />
	</resultMap>
	
	<select id="selectMonthListByNo" parameterType="_int" resultMap="monthDetailResultMap">
		SELECT 
		    M.CATEGORY,
		    M.CHAL_NO,
		    M.CHAL_TITLE,
		    M.CHAL_CONTENT,
		    M.CHAL_IMG_PATH,
		    M.CHAL_POINT,
		    M.CHAL_COUNT,
		    M.CHAL_CONTENT,
		    M.START_DATE,
		    M.END_DATE,
		    M.CHAL_STATUS,
		    R.REPLY_NO AS R_REPLY_NO,
		    R.MEM_NO AS R_MEM_NO,
		    R.CHAL_NO AS R_CHAL_NO,
		    R.CONTENT AS R_CONTENT,
		    R.REPLY_DATE AS R_REPLY_DATE,
		    R.MODIFY_DATE AS R_MODIFY_DATE,
		    R.REPLY_STATUS AS R_REPLY_STATUS,
		    MEMBER.MODIFY_IMG_NAME AS R_MODIFY_IMG_NAME,
		    MEMBER.ID AS R_ID
		FROM CHAL_MONTH M
		LEFT OUTER JOIN CHAL_REPLY R ON (M.CHAL_NO = R.CHAL_NO)
		LEFT OUTER JOIN MEMBER MEMBER ON (R.MEM_NO = MEMBER.NO)
		WHERE M.CHAL_NO = #{ chalNo }
		ORDER BY R.REPLY_NO DESC
	</select>
	
	<!-- 이달의 챌린지 전체 목록 개수 조회 -->
  	<select id="getBoardCount" parameterType="map" resultType="_int">
  		SELECT COUNT (*)
  		FROM CHAL_MONTH
  		WHERE CHAL_STATUS = 'Y'
  	</select>
  	
	<!-- 이달의 챌린지 목록 조회 -->
	<select id="findAllMonth" parameterType="map" resultMap="MonthListResultMap">
		<include refid="monthListSql" />
		ORDER BY CHAL_NO DESC
  	</select>
  	
  	<!-- 이달의 챌린지 목록 조회 + 정렬 -->
  	<select id="findAllMonthArrange" parameterType="string" resultMap="MonthListResultMap">
		<include refid="monthListSql" />
		<if test="arrange == '최신순'">
			ORDER BY CHAL_NO DESC
		</if>
		<if test="arrange == '높은포인트순'">
			ORDER BY CHAL_POINT DESC, CHAL_NO DESC
		</if>
		<if test="arrange == '낮은포인트순'">
			ORDER BY CHAL_POINT ASC, CHAL_NO DESC
		</if>
  	</select>
  	
  	<!-- 이달의 챌린지 상세 조회 -->
  	<!-- <select id="selectMonthListByNo" parameterType="_int" resultMap="MonthListResultMap">
		<include refid="monthListSql" />
		WHERE CHAL_NO = #{ chalNo }
	</select> -->
	
	<!-- 이달의 챌린지 인증 완료 시, 완료 챌린지명 / 파일명 조회 -->
	<select id="findMonthCompleteList" parameterType="map" resultMap="MonthMemberResultMap">
		SELECT
		    T.CHAL_TITLE AS T_CHAL_TITLE,
		    T.CHAL_POINT AS T_CHAL_POINT,
		    M.RENAMED_FILENAME AS M_RENAMED_FILENAME
		FROM CHAL_MONTH_MEM M
		JOIN CHAL_MONTH T ON (M.CHAL_NO = T.CHAL_NO)
		WHERE M.CHAL_NO = #{ chalNo } AND M.MEM_NO = #{ no }
		ORDER BY NO DESC
	</select>
	
	<!-- 이달의 챌린지 인증 시 참여 회원 저장 -->
  	<insert id="insertMonthMember" parameterType="map" useGeneratedKeys="true" keyColumn="NO" keyProperty="no">
		INSERT INTO CHAL_MONTH_MEM (
		    NO,
		    MEM_NO,
		    CHAL_NO,
		    CHAL_DATE,
		    ORIGINAL_FILENAME,
		    RENAMED_FILENAME,
		    CHAL_COUNT,
		    CHAL_STATUS,
		    CHAL_POINT,
		    CHAL_POINT_STATUS
		) VALUES (
		    SEQ_CHLG_MONTH_MEM.NEXTVAL,
		    #{ no },
		    #{ chalNo },
		    SYSDATE,
		    #{ originalFilename },
			#{ renamedFilename },
		    1,
		    DEFAULT,
		    1000,
		    DEFAULT
		)
	</insert>
	
	<!-- 참여 중인 사용자 목록 조회 -->
	<select id="findOngoingUserList" parameterType="map" resultMap="MonthMemberResultMap">
		SELECT DISTINCT
			MEMBER.MODIFY_IMG_NAME AS MEMBER_MODIFY_IMG_NAME,
			MEMBER.ID AS MEMBER_ID
		FROM MEMBER MEMBER
		JOIN CHAL_MONTH_MEM T ON (MEMBER.NO = T.MEM_NO)
		WHERE CHAL_NO = #{ chalNo } AND MEM_NO != #{ no }
	</select>
	
	<!-- 참여 중인 사용자 목록 갯수 조회 -->
	<select id="findOngoingUserCount" parameterType="_int" resultType="_int">
		SELECT COUNT (DISTINCT MEM_NO)
		FROM MEMBER MEMBER
		JOIN CHAL_MONTH_MEM T ON (MEMBER.NO = T.MEM_NO)
		WHERE CHAL_NO = #{ chalNo } AND MEM_NO != #{ no }
	</select>
	
	<!-- 이달의 챌린지 참여 횟수 조회 -->
	<select id="getMonthGuage" parameterType="arraylist" resultMap="MonthMemberResultMap">
		SELECT CHAL_COUNT
		FROM CHAL_MONTH_MEM
		WHERE MEM_NO = #{ no } AND CHAL_NO = #{ chalNo }
	</select>
	
	<!-- 댓글 작성 -->
	<insert id="insertReply" parameterType="map" useGeneratedKeys="true" keyColumn="REPLY_NO" keyProperty="replyNo">
		INSERT INTO CHAL_REPLY (
			REPLY_NO,
			MEM_NO,
			CHAL_NO,
			CONTENT,
			REPLY_DATE,
			MODIFY_DATE,
			REPLY_STATUS
		)
    	VALUES (
    		SEQ_CHAL_REPLY.NEXTVAL,
    		#{ memNo },
    		#{ chalNo },
    		#{ content },
    		SYSDATE,
    		NULL,
    		DEFAULT
    	)
	</insert>
	
	<!-- 댓글 수정 -->
	<update id="updateReply" parameterType="Reply">
		UPDATE CHAL_REPLY
		SET CONTENT = #{ content }
		WHERE REPLY_NO = #{ replyNo }
	</update>
	
	<!-- 댓글 목록 조회 -->
	<select id="findReplyByNo" parameterType="map" resultMap="replyResultMap">
		SELECT *
		FROM CHAL_REPLY
		WHERE MEM_NO = #{ no }
	</select>
	
	<!-- 댓글 삭제 -->
	<update id="updateReplyStatus" parameterType="map">
		UPDATE CHAL_REPLY 
		SET REPLY_STATUS = #{ replyStatus } 
		WHERE REPLY_NO = #{ replyNo }
	</update>
</mapper>
